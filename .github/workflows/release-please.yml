name: Release Please

on:
  push:
    branches: [master]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

  publish:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v5

      - name: Set version from tag
        env:
          TAG: ${{ needs.release-please.outputs.tag_name }}
        run: |
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION="${TAG#v}"
          elif [[ "$TAG" =~ ^goodreads-tools-v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION="${TAG#goodreads-tools-v}"
          else
            echo "Tag must be vX.Y.Z or goodreads-tools-vX.Y.Z" >&2
            exit 1
          fi
          export VERSION
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          version = os.environ["VERSION"]
          path = Path("pyproject.toml")
          content = path.read_text(encoding="utf-8")
          updated = re.sub(r'(?m)^version = "[^"]+"', f'version = "{version}"', content)
          if content == updated:
              print(f"Version already set to {version}")
          else:
              path.write_text(updated, encoding="utf-8")
              print(f"Set version to {version}")
          PY
        shell: bash

      - name: Build
        run: uv build

      - name: Publish
        uses: pypa/gh-action-pypi-publish@release/v1
